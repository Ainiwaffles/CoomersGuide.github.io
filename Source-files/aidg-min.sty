%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Style created for typesetting several /aidg/ community guides.
%    NEEDS LUALATEX TO COMPILE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{aidg-min}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    PACKAGES TO LOAD
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage[activate={true,nocompatibility},final,protrusion=true,tracking=true,factor=1000,stretch=10,shrink=10]{microtype} % A bit closer to typographic perfection
%\RequirePackage{imakeidx}
\RequirePackage[hidelinks]{hyperref} % Neeeded for cross-references and clickable links
\RequirePackage{hyperxmp} % For embedding XMP metadata into PDF
\RequirePackage[numbered,open=true,openlevel=2]{bookmark} % Better version of hyperref bookmarks
\RequirePackage{scrdate} % For setting universal date standard
\RequirePackage[dvipsnames,cmyk,hyperref]{xcolor} % Color definitions
\RequirePackage{fontspec} % Easy font selection and size declarations
\RequirePackage{enumitem} % Lists formatting
\RequirePackage[many]{tcolorbox} % For typesetting World Info entry box
\RequirePackage[os=win]{menukeys} % Used for highlighting Input modes
\RequirePackage{subfiles} % For separating project into disctict files
\RequirePackage[capitalize,nameinlink]{cleveref} % Easier labeling
\RequirePackage[backend=biber,style=alphabetic]{biblatex}
\RequirePackage{soulutf8} % Text highlighting
\RequirePackage{xspace} % Adaptive space in macro shortcuts
\RequirePackage{etoolbox}
\RequirePackage{changelog}
%\RequirePackage[headsepline,autooneside=false,automark]{scrlayer-scrpage} % Customizable header and footer via page styles
\RequirePackage[automake,nopostdot,toc,]{glossaries}
\RequirePackage[all]{nowidow}
\RequirePackage{multicol}
\RequirePackage{xsavebox}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    PACKAGE SETTINGS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeglossaries

% KOMA-Script package options

\KOMAoptions{
%toc=sectionentrydotfill, % Adds dots in ToC for sections
%titlepage=true,
toc=bibliography,
}


\renewcommand*{\titlepagestyle}{empty}
\renewcommand*{\partpagestyle}{empty}

\setkomafont{part}{\fontsize{42pt}{50.4pt}\selectfont}
\addtokomafont{disposition}{\rmfamily}
%\addtokomafont{sectionentry}{\bfseries}
%\renewcommand*{\chapterheadstartvskip}{\vspace*{0em}}

\setkomafont{dictumtext}{\itshape\small}
\setkomafont{dictumauthor}{\normalfont}
\renewcommand*\dictumwidth{0.3333\linewidth}
\renewcommand*\dictumauthorformat[1]{\small--- #1\vspace{1em}}
\renewcommand*\dictumrule{}

% enumitem
\setlist[description]{ %
  %topsep=30pt,               % space before start / after end of list
  %itemsep=5pt,               % space between items
  style=nextline,
  labelsep=2em,
  font=\rmfamily\bfseries, % set the label font
}

% Patches KOMA-Script from starting new page on chapter % add credit link later
\makeatletter
\patchcmd{\scr@startchapter}{\if@openright\cleardoublepage\else\clearpage\fi}{}{}{}
\makeatother

% cleveref

%\crefname{section}{\S}{\S\S}
%\Crefname{section}{\S}{\S\S}
%\crefname{subsection}{\S}{\S\S}
%\Crefname{subsection}{\S}{\S\S}
%\crefname{subsubsection}{\S}{\S\S}
%\Crefname{subsubsection}{\S}{\S\S}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    COLOR DEFINITIONS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\definecolor{bluebox}{rgb}{0.0, 0.08, 0.99}
\definecolor{yellowbox}{rgb}{0.99, 0.99, 0.8}
\definecolor{bisque}{rgb}{0.96, 0.96, 0.86}
\definecolor{beaublue}{rgb}{0.74, 0.83, 0.9}
\definecolor{memecolor}{cmyk}{0.03, 0.00, 0.43, 0.32}

\definecolor{chaptercolor}{cmyk}{1, 0.5, 0, 0}

%\newcommand\myshade{85}
%\colorlet{mylinkcolor}{violet}
%\colorlet{mycitecolor}{YellowOrange}
%\colorlet{myurlcolor}{Aquamarine}

%Hyperref links color
%\hypersetup{ %
% Color scheme definitions for links
% Taken from https://tex.stackexchange.com/a/176372
%  linkcolor  = mylinkcolor!\myshade!black,
%  citecolor  = mycitecolor!\myshade!black,
%  urlcolor   = myurlcolor!\myshade!black,
%  colorlinks = true,
%}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    GENERAL STYLE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\frenchspacing % Forces single space between sentences

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    COVER AND TITLE OUTPUT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\addtokomafont{author}{\bfseries\huge}
\addtokomafont{date}{\bfseries\Large}

\NewDocumentCommand{\makeaidgtitle}{ m O{keepaspectratio} m m m O{}}{

\title{
	\textls{\uppercase{#1}}\\
	\vspace*{\fill}
	\tcbox[colback=bluebox,
left=0mm,right=0mm,top=0mm,bottom=0mm,boxsep=1mm,boxrule=0.5pt,
]{%
\includegraphics[#2]{#3}}
	%\vspace*{\fill}
}

\author{%\vspace*{\fill}
	by\\#4\\\Large
	#6%\href{mailto:#6}{#6}
}

\date{\vspace*{\fill}
	Version #5\\
	\ISOToday	
}

\pagecolor{bisque}
\maketitle
\nopagecolor

}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%     EMBEDDING XMP METADATA
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\embedcoomermetadata}{
\hypersetup{ % This embeds XMP metadata into the PDF.
pdftitle={A Coomer's Guide to AI Dungeon},
pdfauthor={Manwhore},
pdfauthortitle={Power Coomer},
pdfkeywords={AI Dungeon, coomer, guide},
pdfcontacturl={https://github.com/CoomersGuide/CoomersGuide.github.io},
baseurl={https://github.com/CoomersGuide/CoomersGuide.github.io},
pdfurl={https://github.com/CoomersGuide/CoomersGuide.github.io/blob/main/A\%20Coomer's\%20Guide\%20to\%20AI\%20Dungeon.pdf},
pdfversionid={3},
pdfpubtype={manual},
pdflang={en-US},
pdfmetalang={en},
}
}

\newcommand{\embedavsfagmetadata}{
\hypersetup{ % This embeds XMP metadata into the PDF.
pdftitle={/AIDG/ Writing Guide},
pdfauthor={Avsfag},
pdfauthortitle={Power Coomer},
pdfkeywords={AI Dungeon, writing, guide},
%pdfcontacturl={https://github.com/CoomersGuide/CoomersGuide.github.io},
%baseurl={https://github.com/CoomersGuide/CoomersGuide.github.io},
%pdfurl={https://github.com/CoomersGuide/CoomersGuide.github.io/blob/main/A\%20Coomer's\%20Guide\%20to\%20AI\%20Dungeon.pdf},
pdfversionid={1},
pdfpubtype={manual},
pdflang={en-US},
pdfmetalang={en},
}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    CUSTOM MACROS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\keyS}[1]{\keys{\rmfamily {#1}}} % For menukeys to use serifs

\newcommand{\aid}{AI Dungeon\xspace}
\newcommand{\wi}{World Info\xspace}
\newcommand{\an}{Author's Note\xspace}
\newcommand{\ans}{Author's Notes\xspace}

\newcommand{\rem}{/remember\xspace}
\newcommand{\Do}{Do\xspace}
\newcommand{\say}{Say\xspace}
\newcommand{\story}{Story\xspace}

\newcommand{\Input}[1]{\textcolor{green}{#1}}
\newcommand{\alter}[1]{\textcolor{yellow}{#1}}
\newcommand{\retry}[1]{\textcolor{red}{#1}}

%\newcommand{\lettr}[2]{\lettrine[lines=3]{#1}{#2}}


% https://tex.stackexchange.com/a/224746
\newcommand{\lettr}{}

\NewDocumentCommand{\epig}{ O{} O{} m }{
	\setchapterpreamble[u]{
	\dictum[\ifblank{#1#2}{}{\IfValueTF={#1}{#1}{}\ifblank{#2}{}{,\space\em}\IfValueTF={#2}{#2}{}}]{``#3''}
}
}

\newcommand{\memearrow}[1]{\textcolor{green}{>#1}}

% -----------------------------------------
% https://tex.stackexchange.com/a/544121
% -----------------------------------------

% I know this is an old question, but the answers from both Gonzalo Medina and Stephen may interact poorly with hyperref.
% I did not test the titlefoot package but, from my limited understanding of the LaTeX code, it seems it may not be immune either.

% Apparently, however, we are "safe" by using @xfootnotenext, as hyperref's implementation of it delegates to the default LaTeX footnote code.
% And it is simple to do so, just call \footnotetext with an optional parameter.
% To do that, switch footnote markers temporarily to symbols and select 0 as the symbol.
% Nothing gets printed (no symbol for 0), nothing gets added to the text (we are just using footnotetext), and hyperref does not try to add anchors or links.

\newcommand\extrafootertext[1]{%
    \bgroup
    \renewcommand\thefootnote{\fnsymbol{footnote}}%
    \renewcommand\thempfootnote{\fnsymbol{mpfootnote}}%
    \footnotetext[0]{#1}%
    \egroup
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    CUSTOM TCOLORBOXES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% World Info
\newtcolorbox{WI}[1]{ % Box used for World Info examples
enhanced,
%colframe=bluebox, %aidg
%colback=yellowbox, %aidg
colframe=black,
colback=white,
%colback=beaublue,
%coltitle=white, %aidg
%coltitle=black,
fonttitle=\bfseries,
halign title=flush center,
title={#1},
}

\newtcolorbox{/rm}{ % Box used for Memory examples
%enhanced,
lowerbox=visible,
colframe=bluebox,
colback=yellowbox,
%colback=beaublue,
%coltitle=white,
%fonttitle=\bfseries,
%halign title=flush center,
%title={#1},
}

%Story snippet
\newtcolorbox{storyb}{
enhanced,
colframe=bluebox,
colback=beaublue,
}

% Story
\NewTColorBox[auto counter]{Story}{ m }{% Input box
enhanced,
title={Story example \textnumero\thetcbcounter: #1},
halign title=flush center,
colframe=bluebox,
colback=beaublue,
before lower*={
\begin{center}
\tikz \node [label=right:Human Input,draw,fill=green] (input) {};
\tikz \node [label=right:Altered Response,draw,fill=yellow] (alter) {};
\tikz \node [label=right:Retried Response,draw,fill=red] (retry) {};
\end{center}
},  
}

\newcommand{\tcolortoc}{\tableofcontents}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    PATCHES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% https://tex.stackexchange.com/a/48502
% -----------------------------------------

% The source of the problem is that both xcolor and soul use \dimen@ as a temporary register.
% And soul uses it at a place where it can't be sure that other commands temper around with this dimen.
% You can redefine the internal soul command, or you can use \convertcolorsUfalse so that xcolor no longer recalculate color at usage:

% If you don't want to copy the definition from soul.sty, here's a way to patch the command:

\makeatletter
\patchcmd{\SOUL@ulunderline}{\dimen@}{\SOUL@dimen}{}{}
\patchcmd{\SOUL@ulunderline}{\dimen@}{\SOUL@dimen}{}{}
\patchcmd{\SOUL@ulunderline}{\dimen@}{\SOUL@dimen}{}{}
\newdimen\SOUL@dimen
\makeatother

% This will work even if the soul package is updated (because the patch won't succeed).
% -----------------------------------------

% code stored for later
%https://tex.stackexchange.com/a/348146

%\usepackage{xstring}

%\makeatletter
%\let\ltx@@chapter\@chapter
%\def\@chapter[#1]#2 #3 {\ltx@@chapter[#1]{#2}\lettrine[nindent=0em]{\StrLeft{#3}{1}}{\@gobble#3}\ }
%\makeatother

