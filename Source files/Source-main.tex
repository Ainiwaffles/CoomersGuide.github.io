% This is a LaTeX implementation of the original guide by Manwhore anon.
% His work is fantastic and everyone who uses AI Dungeon should read it in full.
% I made some formatting additions to the PDF since it was first made, but the content remains the same.
% Can be compiled with pdfLaTeX and LuaLaTeX.

\documentclass[a4paper,12pt,american,]{scrreprt} % KOMA-Script classes offer a ton of good features and are generally better for European users

\usepackage[activate={true,nocompatibility},
final,
protrusion=true,
tracking=true,
factor=1000,
stretch=10,
shrink=10]{microtype} % A bit closer to typographic perfection

\usepackage[pdfdisplaydoctitle,pdfa,unicode,pdfversion=1.7]{hyperref}
\usepackage{hyperxmp} % For embedding XMP metadata into PDF
\usepackage[numbered,open=true,openlevel=2]{bookmark} % Better version of hyperref bookmarks
\usepackage{scrdate} % For setting universal date standard
\usepackage[dvipsnames,cmyk,hyperref]{xcolor}
\usepackage{tagpdf}
\tagpdfsetup{activate-all,
%uncompress,
}

\definecolor{bluebox}{rgb}{0.0, 0.08, 0.99}
\definecolor{yellowbox}{rgb}{0.99, 0.99, 0.8}
\definecolor{bisque}{rgb}{0.96, 0.96, 0.86}

\newcommand\myshade{85}
\colorlet{mylinkcolor}{violet}
\colorlet{mycitecolor}{YellowOrange}
\colorlet{myurlcolor}{Aquamarine}

%This embeds XMP metadata into the PDF.
%pdfnumpages and pdfpagerange must be loaded after \begin{document} for totpages package to work
\hypersetup{ %
% Color scheme definitions for links
% Taken from https://tex.stackexchange.com/a/176372
  linkcolor  = mylinkcolor!\myshade!black,
  citecolor  = mycitecolor!\myshade!black,
  urlcolor   = myurlcolor!\myshade!black,
  colorlinks = true,
% PDF metadata setup
pdftitle={A Coomer's Guide to AI Dungeon, v3},
pdfauthor={Manwhore},
pdfkeywords={AI Dungeon, coomer, guide},
pdfcontacturl={https://rentry.co/RentryCompendium},
baseurl={https://gofile.io/d/3hNpLQ},
pdfversionid={0.4},
pdfpubtype={manual},
pdflang={en-US},
pdfmetalang={en},
pdfapart=3,
pdfaconformance=a,
%pdfuapart=1,
pdfxstandard={PDF/X-3:2003},
}

\usepackage{embedfile} % Embeds sources and other necessary files for compiling the PDF

\embedfile[ % An archive with all the files needed to produce the PDF
filespec={Source-files.zip},
ucfilespec={Source-files.zip},
mimetype={application/zip},
desc={Full arhive of source files},
id={Source},
afrelationship={/Source},
]{Source-files.zip}

\usepackage[many]{tcolorbox} % For typesetting World Info entry box
\usepackage[os=win]{menukeys}

% -----------------------------------------
% https://tex.stackexchange.com/a/568785
% Code needed to prevent paragraph indentation after tcolorboxes
% -----------------------------------------
% Appending \@endparenv, which is used by every list environment, to /tcb/after seems to work.

% Update: For breakable boxes, some experimental attempt is added.

%\makeatletter
%\tcbset{
%  after app={%
%    \ifx\tcb@drawcolorbox\tcb@drawcolorbox@breakable
%    \else
%      % add only when not breakabel
%      \@endparenv
%    \fi
%  }
%}

% for breakable
%\appto\tcb@use@after@lastbox{\@endparenv\@doendpe}
%\makeatother
% -----------------------------------------

\newtcolorbox{WIbox}[1]{ % Box used for World Info examples
enhanced,
colframe=bluebox,
colback=yellowbox,
coltitle=white,
fonttitle=\bfseries,
halign title=flush center,
title={#1},
}

%\KOMAoptions{
%toc=sectionentrydotfill, % Adds dots in ToC for sections
%titlepage=true,
%toc=bibliography,
%}
\frenchspacing % Forces single space between sentences
\addtokomafont{disposition}{\rmfamily}
%\addtokomafont{sectionentry}{\bfseries}

% ------------------------------------------
% https://tex.stackexchange.com/a/536060
% Code taken to pass PDF/A and PDF/X color model validation check
% -----------------------------------------
% Which paper did the authors have in mind when they created the document?
\immediate\pdfobj stream attr{/N 4} file{PSO-Uncoated-ISO12647-eci.icc}
\pdfcatalog{%
  /OutputIntents [ <<
    /Type /OutputIntent
    /S /GTS_PDFX
    /DestOutputProfile \the\pdflastobj\space 0 R
    /Info(PSO Uncoated ISO12647 (ECI))
    /OutputCondition(Offset printing, according to ISO 12647-2:2004/Amd1, OFCOM, paper type 4 = uncoated white, 115 g/m2, tone value increase curves C (CMY) and D (K))
    /OutputConditionIdentifier (Uncoated FOGRA47)
    /RegistryName(http://www.color.org)
  >>
  <<
    /Type /OutputIntent
    /S /GTS_PDFA1
    /DestOutputProfile \the\pdflastobj\space 0 R
    /Info(PSO Uncoated ISO12647 (ECI))
    /OutputCondition(Offset printing, according to ISO 12647-2:2004/Amd1, OFCOM, paper type 4 = uncoated white, 115 g/m2, tone value increase curves C (CMY) and D (K))
    /OutputConditionIdentifier (Uncoated FOGRA47)
    /RegistryName(http://www.color.org)
  >> ]
}

\makeatletter
% Bugfix of hyperref to produce CMYK links
\let\HyColor@HyperrefBorderColor\HyColor@XZeroOneThreeFour
\makeatother

\makeatletter
% We need to tell PDF/X the final format of the paper. This needs adjustment if you want graphics on the page border, called bleeding
\@tempdima=0.99626400996264009962\paperwidth
\edef\boxwd{\strip@pt\@tempdima}
\@tempdima=0.99626400996264009962\paperheight
\edef\boxht{\strip@pt\@tempdima}
\makeatother
\edef\next{%
  \protect\pdfpageattr{
    /TrimBox[0.0 0.0 \boxwd\space \boxht]
  }%
}
\next

% This example uses the rather new version of hyperxmp.
% It validates in Acrobat DC, VeraPDF and 3-Heights when compiled either in pdfLaTeX or LuaLaTeX.
%The hyperref workaround is from it's issue tracker.

% I used FOGRA47 as the colour profile because it is small and thus safe.
% You don't easily risk colours which cannot be printed or displayed on screen.
% The profile is available from European Color Initiative.

% ------------------------------------------
\usepackage{subfiles} % For separating project into disctict files

\usepackage{moresize}
\usepackage{titling}

\usepackage{cleveref}

\usepackage[backend=biber,style=alphabetic]{biblatex}
\addbibresource{Bibliography.bib}

\newcommand{\keyS}[1]{\keys{\rmfamily {#1}}}

\newcommand{\chapteR}[1]{
\begingroup
\let\clearpage\relax
\chapter{#1}
\endgroup}

\begin{document}

\subfile{Source-cover}

\subfile{Source-ToC}

\subfile{Source-content}

\nocite{*}
\clearpage
\printbibliography[title={Bibliography}]

\clearpage

\subfile{Source-appendix}

\end{document}
